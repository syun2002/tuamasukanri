<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>アイマスツアーズ カード管理（OpenCV.js）</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }
    header {
      background: #ff99c8;
      color: #fff;
      padding: 12px 20px;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header small {
      font-size: 11px;
      display: block;
      opacity: 0.8;
    }
    main {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
      gap: 10px;
    }
    .panel {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    #camera-panel {
      flex: 1 1 320px;
      min-width: 320px;
    }
    #list-panel {
      flex: 1 1 320px;
      min-width: 320px;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
    }
    h2 {
      margin-top: 0;
      font-size: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }
    video, canvas {
      width: 100%;
      max-width: 480px;
      border-radius: 6px;
      background: #000;
    }
    .controls {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    button {
      border-radius: 4px;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    button.primary {
      background: #ff6fa3;
      color: #fff;
    }
    button.secondary {
      background: #eee;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }
    .field {
      margin-top: 8px;
      font-size: 13px;
    }
    .field label {
      display: block;
      margin-bottom: 3px;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 5px 6px;
      font-size: 13px;
    }
    input[type="file"] {
      font-size: 12px;
    }
    .cards-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .progress-bar-wrap {
      flex: 1;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff6fa3, #ffd6ff);
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text {
      font-size: 11px;
      white-space: nowrap;
      min-width: 90px;
      text-align: right;
    }
    .card-list {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
    }
    .card-item {
      border-radius: 6px;
      border: 1px solid #eee;
      overflow: hidden;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      font-size: 12px;
      position: relative;
    }
    .card-item.obtained {
      border-color: #4caf50;
      box-shadow: 0 0 0 2px rgba(76,175,80,0.2);
    }
    .card-thumb-wrap {
      width: 100%;
      padding-top: 140%;
      position: relative;
      background: #ddd;
    }
    .card-thumb-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .card-body {
      padding: 4px 6px 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .card-name {
      font-weight: bold;
      font-size: 12px;
    }
    .card-meta {
      font-size: 11px;
      color: #666;
    }
    .card-status {
      font-size: 11px;
      margin-top: 2px;
    }
    .card-status span {
      padding: 1px 4px;
      border-radius: 999px;
      font-size: 10px;
      background: #eee;
    }
    .card-status span.obtained {
      background: #4caf50;
      color: #fff;
    }
    .badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(76, 175, 80, 0.9);
      color: #fff;
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 999px;
    }
    .hint {
      font-size: 11px;
      color: #999;
    }
    .legend {
      font-size: 11px;
      margin-top: 6px;
      color: #555;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      margin-right: 10px;
      gap: 3px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .legend-dot.obtained {
      background: #4caf50;
    }
    .legend-dot.not {
      background: #ccc;
    }
    .match-log {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
      max-height: 100px;
      overflow-y: auto;
      border-top: 1px dashed #eee;
      padding-top: 4px;
    }
    .match-log div {
      margin-bottom: 2px;
    }
  </style>
</head>
<body>
<header>
  <h1>アイマスツアーズ カード取得管理</h1>
  <small>OpenCV.js ORB特徴量マッチング ＋ カメラ認識対応</small>
</header>

<main>
  <!-- カメラ＆認識パネル -->
  <section id="camera-panel" class="panel">
    <h2>カメラ認識 / 参照カード登録</h2>

    <video id="video" autoplay playsinline></video>
    <canvas id="captureCanvas" style="display:none;"></canvas>

    <div class="controls">
      <button id="startCameraBtn" class="secondary">カメラ開始</button>
      <button id="stopCameraBtn" class="secondary" disabled>停止</button>
      <button id="captureBtn" class="primary" disabled>このフレームでカード判定</button>
    </div>

    <div class="status" id="cameraStatus">OpenCV.js 読み込み中…</div>

    <div class="field">
      <label for="cardNameInput">新しいカードを追加（参照画像登録）</label>
      <input id="cardNameInput" type="text" placeholder="カード名（例: 天海春香 SR）」 />
    </div>
    <div class="field">
      <label>参照画像の選択（ファイル or 現在のカメラフレーム）</label>
      <input id="refFileInput" type="file" accept="image/*">
      <button id="useCurrentFrameBtn" class="secondary" disabled>カメラフレームを参照画像として登録</button>
      <div class="hint">カード一覧に使う画像です。カード正面ができるだけ大きく写るようにしてください。</div>
    </div>
    <div class="controls">
      <button id="addCardBtn" class="primary" disabled>カード一覧に追加</button>
    </div>

    <div class="legend">
      <span><span class="legend-dot obtained"></span>取得済</span>
      <span><span class="legend-dot not"></span>未取得</span>
    </div>

    <div class="match-log" id="matchLog"></div>
  </section>

  <!-- カード一覧 & 取得率パネル -->
  <section id="list-panel" class="panel">
    <div class="cards-header">
      <h2>カード一覧</h2>
      <div style="flex:1; display:flex; align-items:center; gap:6px;">
        <div class="progress-bar-wrap">
          <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="progress-text">0 / 0 (0%)</div>
      </div>
    </div>
    <div class="hint">カードを認識すると自動的に「取得済」になります。</div>
    <div class="card-list" id="cardList"></div>
  </section>
</main>

<!-- OpenCV.js（公式CDNの一例。環境によって変更可） -->
<script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>

<script>
  // -----------------------------
  // データ構造 & ストレージ
  // -----------------------------

  const STORAGE_KEY = 'imas_tours_cards_v1';

  /**
   * card = {
   *   id: string,
   *   name: string,
   *   imageDataUrl: string,
   *   obtained: boolean
   * }
   */
  let cards = [];

  function loadCards() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        cards = JSON.parse(raw);
      } else {
        cards = [];
      }
    } catch (e) {
      console.error(e);
      cards = [];
    }
    renderCardList();
  }

  function saveCards() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
  }

  // -----------------------------
  // DOM 取得
  // -----------------------------

  const video = document.getElementById('video');
  const captureCanvas = document.getElementById('captureCanvas');
  const startCameraBtn = document.getElementById('startCameraBtn');
  const stopCameraBtn = document.getElementById('stopCameraBtn');
  const captureBtn = document.getElementById('captureBtn');
  const useCurrentFrameBtn = document.getElementById('useCurrentFrameBtn');
  const cameraStatus = document.getElementById('cameraStatus');
  const cardNameInput = document.getElementById('cardNameInput');
  const refFileInput = document.getElementById('refFileInput');
  const addCardBtn = document.getElementById('addCardBtn');
  const cardListEl = document.getElementById('cardList');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const matchLog = document.getElementById('matchLog');

  let stream = null;
  let opencvReady = false;

  // 参照画像として保持する一時的なDataURL
  let pendingRefImageDataUrl = null;

  // -----------------------------
  // OpenCV.js 読み込み待ち
  // -----------------------------
  function onOpenCvReady() {
    opencvReady = true;
    cameraStatus.textContent = 'OpenCV.js 準備完了。カメラを開始できます。';
    captureBtn.disabled = !stream;
    useCurrentFrameBtn.disabled = !stream;
  }

  // opencv.js が読み込まれると Module.onRuntimeInitialized が呼ばれる
  window.Module = {
    onRuntimeInitialized() {
      onOpenCvReady();
    }
  };

  // -----------------------------
  // カメラ制御
  // -----------------------------

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' },
        audio: false
      });
      video.srcObject = stream;
      cameraStatus.textContent = 'カメラ動作中。カードを写して「カード判定」を押してください。';
      startCameraBtn.disabled = true;
      stopCameraBtn.disabled = false;
      captureBtn.disabled = !opencvReady;
      useCurrentFrameBtn.disabled = !opencvReady;
    } catch (e) {
      console.error(e);
      cameraStatus.textContent = 'カメラの起動に失敗しました。ブラウザの権限設定を確認してください。';
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    startCameraBtn.disabled = false;
    stopCameraBtn.disabled = true;
    captureBtn.disabled = true;
    useCurrentFrameBtn.disabled = true;
    cameraStatus.textContent = 'カメラ停止中。';
  }

  startCameraBtn.addEventListener('click', startCamera);
  stopCameraBtn.addEventListener('click', stopCamera);

  // -----------------------------
  // カメラフレームをCanvasに取得
  // -----------------------------

  function grabFrameToCanvas() {
    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) return null;
    captureCanvas.width = w;
    captureCanvas.height = h;
    const ctx = captureCanvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    return captureCanvas;
  }

  // -----------------------------
  // DataURL への変換
  // -----------------------------

  function canvasToDataUrl(canvas, mimeType = 'image/jpeg', quality = 0.9) {
    return canvas.toDataURL(mimeType, quality);
  }

  function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  // -----------------------------
  // 参照画像登録フロー
  // -----------------------------

  // ファイル選択 → DataURL を pendingRefImageDataUrl に保持
  refFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const dataUrl = await fileToDataUrl(file);
      pendingRefImageDataUrl = dataUrl;
      cameraStatus.textContent = '参照画像を読み込みました。「カード一覧に追加」で登録できます。';
      updateAddButtonState();
    } catch (err) {
      console.error(err);
      cameraStatus.textContent = '参照画像の読み込みに失敗しました。';
    }
  });

  // カメラからフレームを取得して参照画像に使う
  useCurrentFrameBtn.addEventListener('click', () => {
    const canvas = grabFrameToCanvas();
    if (!canvas) {
      cameraStatus.textContent = 'カメラフレームを取得できませんでした。';
      return;
    }
    pendingRefImageDataUrl = canvasToDataUrl(canvas);
    cameraStatus.textContent = '現在のカメラフレームを参照画像としてセットしました。';
    updateAddButtonState();
  });

  function updateAddButtonState() {
    const nameFilled = cardNameInput.value.trim().length > 0;
    addCardBtn.disabled = !(nameFilled && pendingRefImageDataUrl);
  }

  cardNameInput.addEventListener('input', updateAddButtonState);

  // カード追加
  addCardBtn.addEventListener('click', () => {
    const name = cardNameInput.value.trim();
    if (!name || !pendingRefImageDataUrl) return;

    const card = {
      id: 'card_' + Date.now(),
      name,
      imageDataUrl: pendingRefImageDataUrl,
      obtained: false
    };
    cards.push(card);
    saveCards();
    renderCardList();

    cardNameInput.value = '';
    refFileInput.value = '';
    pendingRefImageDataUrl = null;
    addCardBtn.disabled = true;
    cameraStatus.textContent = `「${card.name}」をカード一覧に追加しました。`;
  });


function playBeep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "sine";      // 音の種類（sine = ピー）
  osc.frequency.value = 880; // 周波数（高めの音）

  gain.gain.setValueAtTime(0.5, ctx.currentTime); // 音量
  gain.gain.exponentialRampToValueAtTime(0.002, ctx.currentTime + 0.15);

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start();
  osc.stop(ctx.currentTime + 0.15); // 0.15秒で終了
}

  // -----------------------------
  // カード一覧の描画 & 取得率
  // -----------------------------

  function renderCardList() {
    cardListEl.innerHTML = '';
    cards.forEach(card => {
      const item = document.createElement('div');
      item.className = 'card-item' + (card.obtained ? ' obtained' : '');

      const thumbWrap = document.createElement('div');
      thumbWrap.className = 'card-thumb-wrap';
      const img = document.createElement('img');
      img.src = card.imageDataUrl;
      thumbWrap.appendChild(img);

      const body = document.createElement('div');
      body.className = 'card-body';

      const nameEl = document.createElement('div');
      nameEl.className = 'card-name';
      nameEl.textContent = card.name;

      const metaEl = document.createElement('div');
      metaEl.className = 'card-meta';
      metaEl.textContent = `ID: ${card.id}`;

      const statusEl = document.createElement('div');
      statusEl.className = 'card-status';
      const span = document.createElement('span');
      span.textContent = card.obtained ? '取得済' : '未取得';
      span.className = card.obtained ? 'obtained' : '';
      statusEl.appendChild(span);

      body.appendChild(nameEl);
      body.appendChild(metaEl);
      body.appendChild(statusEl);

// ★ 取得済みなら CLEAR ボタンを追加
    if (card.obtained) {
      const clearBtn = document.createElement('button');
      clearBtn.textContent = 'CLEAR';
      clearBtn.style.marginTop = '4px';
      clearBtn.style.fontSize = '10px';
      clearBtn.style.padding = '2px 6px';
      clearBtn.style.background = '#eee';
      clearBtn.style.borderRadius = '4px';
      clearBtn.onclick = () => {
        card.obtained = false;
        saveCards();
        renderCardList();
      };
      body.appendChild(clearBtn);
    }



      item.appendChild(thumbWrap);
      item.appendChild(body);

      if (card.obtained) {
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = 'GET!';
        item.appendChild(badge);
      }

      cardListEl.appendChild(item);
    });

    updateProgress();
  }

  function updateProgress() {
    const total = cards.length;
    const obtained = cards.filter(c => c.obtained).length;
    const pct = total > 0 ? Math.round((obtained / total) * 100) : 0;
    progressBar.style.width = pct + '%';
    progressText.textContent = `${obtained} / ${total} (${pct}%)`;
  }

  // -----------------------------
  // OpenCV.js で特徴量マッチング
  //   - ORB + BFMatcher(Hamming)
  // -----------------------------
  // 参考: ORB特徴点を用いた画像認識のPoC

  function logMatch(text) {
    const div = document.createElement('div');
    div.textContent = text;
    matchLog.prepend(div);
  }

  function dataUrlToMat(dataUrl) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        try {
          const mat = cv.imread(img);
          resolve(mat);
        } catch (e) {
          reject(e);
        }
      };
      img.onerror = err => reject(err);
      img.src = dataUrl;
    });
  }

  function canvasToMat(canvas) {
    const mat = cv.imread(canvas);
    return mat;
  }

  async function computeOrbDescriptorsFromDataUrl(dataUrl) {
    const src = await dataUrlToMat(dataUrl);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    const orb = new cv.ORB();
    const keypoints = new cv.KeyPointVector();
    const descriptors = new cv.Mat();
    orb.detectAndCompute(gray, new cv.Mat(), keypoints, descriptors);

    src.delete();
    gray.delete();
    orb.delete();
    keypoints.delete();

    return descriptors;
  }

  function computeOrbDescriptorsFromCanvas(canvas) {
    const src = canvasToMat(canvas);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    const orb = new cv.ORB();
    const keypoints = new cv.KeyPointVector();
    const descriptors = new cv.Mat();
    orb.detectAndCompute(gray, new cv.Mat(), keypoints, descriptors);

    src.delete();
    gray.delete();
    orb.delete();
    keypoints.delete();

    return descriptors;
  }

  async function recognizeCardFromCurrentFrame() {
    if (!opencvReady) {
      cameraStatus.textContent = 'OpenCV.js がまだ準備できていません。少し待ってください。';
      return;
    }
    if (!cards.length) {
      cameraStatus.textContent = 'カード一覧が空です。先に参照カードを追加してください。';
      return;
    }

    const canvas = grabFrameToCanvas();
    if (!canvas) {
      cameraStatus.textContent = 'カメラフレームを取得できませんでした。';
      return;
    }

    cameraStatus.textContent = '特徴量抽出とマッチングを実行中…';
    logMatch('---- 新しい判定 ----');

    let frameDesc = null;
    try {
      frameDesc = computeOrbDescriptorsFromCanvas(canvas);
    } catch (e) {
      console.error(e);
      cameraStatus.textContent = 'フレームから特徴量を抽出できませんでした。';
      return;
    }

    if (frameDesc.empty()) {
      frameDesc.delete();
      cameraStatus.textContent = 'フレームから有効な特徴量を取得できませんでした。撮影条件を変えてみてください。';
      return;
    }

    const bf = new cv.BFMatcher(cv.NORM_HAMMING, true);
    let bestCard = null;
    let bestMatchCount = 0;

    for (let card of cards) {
      let cardDesc = null;
      try {
        cardDesc = await computeOrbDescriptorsFromDataUrl(card.imageDataUrl);
      } catch (e) {
        console.error(e);
        logMatch(`カード「${card.name}」の特徴量抽出に失敗`);
        continue;
      }

      if (cardDesc.empty()) {
        cardDesc.delete();
        logMatch(`カード「${card.name}」の特徴量が空です`);
        continue;
      }

      const matches = new cv.DMatchVector();
      bf.match(cardDesc, frameDesc, matches);

      const count = matches.size();
      logMatch(`「${card.name}」: マッチ数 ${count}`);

      if (count > bestMatchCount) {
        bestMatchCount = count;
        bestCard = card;
      }

      matches.delete();
      cardDesc.delete();
    }

    frameDesc.delete();
    bf.delete();

    // マッチ数の閾値（経験的に調整が必要）
    const MATCH_THRESHOLD = 179;

    if (bestCard && bestMatchCount >= MATCH_THRESHOLD) {
      cameraStatus.textContent = `カード認識成功: 「${bestCard.name}」（マッチ数 ${bestMatchCount}）`;
      logMatch(`==> 認識: 「${bestCard.name}」 / マッチ数 ${bestMatchCount}`);

// ★ ファイル不要のビープ音を鳴らす
  playBeep();


      if (!bestCard.obtained) {
        bestCard.obtained = true;
        saveCards();
        renderCardList();
      }
    } else {
      cameraStatus.textContent = `カード認識に失敗しました（最良マッチ数: ${bestMatchCount}）。カードを正面に大きく写して再試行してください。`;
      logMatch('==> 認識失敗');
    }
  }

  captureBtn.addEventListener('click', recognizeCardFromCurrentFrame);


// -----------------------------
// 100フレームごと自動判定
// -----------------------------
let autoDetectEnabled = true;   // 自動判定ON/OFF（必要ならUIで切り替え可能）
let frameCounter = 0;

function autoDetectLoop() {
  if (stream && autoDetectEnabled && opencvReady) {
    frameCounter++;

    // 100フレームに1回だけ判定
    if (frameCounter % 100 === 0) {
      recognizeCardFromCurrentFrame();
    }
  }

  requestAnimationFrame(autoDetectLoop);
}

// 自動ループ開始
requestAnimationFrame(autoDetectLoop);


  // -----------------------------
  // 初期化
  // -----------------------------

  loadCards();
  cameraStatus.textContent = 'OpenCV.js の読み込みを待機中…（数秒かかる場合があります）';
</script>
</body>
</html>