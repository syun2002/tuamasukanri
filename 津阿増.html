<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>アイマスツアーズ カード管理（OpenCV.js）</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }
    header {
      background: #ff99c8;
      color: #fff;
      padding: 12px 20px;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header small {
      font-size: 11px;
      display: block;
      opacity: 0.8;
    }
    main {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
      gap: 10px;
    }
    .panel {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    #camera-panel {
      flex: 1 1 320px;
      min-width: 320px;
    }
    #list-panel {
      flex: 1 1 320px;
      min-width: 320px;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
    }
    h2 {
      margin-top: 0;
      font-size: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }
    video, canvas {
      width: 100%;
      max-width: 480px;
      border-radius: 6px;
      background: #000;
    }
    .controls {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    button {
      border-radius: 4px;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    button.primary {
      background: #ff6fa3;
      color: #fff;
    }
    button.secondary {
      background: #eee;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }
    .field {
      margin-top: 8px;
      font-size: 13px;
    }
    .field label {
      display: block;
      margin-bottom: 3px;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 5px 6px;
      font-size: 13px;
    }
    input[type="file"] {
      font-size: 12px;
    }
    .cards-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .progress-bar-wrap {
      flex: 1;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff6fa3, #ffd6ff);
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text {
      font-size: 11px;
      white-space: nowrap;
      min-width: 90px;
      text-align: right;
    }
    .card-list {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
    }
    .card-item {
      border-radius: 6px;
      border: 1px solid #eee;
      overflow: hidden;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      font-size: 12px;
      position: relative;
    }
    .card-item.obtained {
      border-color: #4caf50;
      box-shadow: 0 0 0 2px rgba(76,175,80,0.2);
    }
    .card-thumb-wrap {
      width: 100%;
      padding-top: 140%;
      position: relative;
      background: #ddd;
    }
    .card-thumb-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .card-body {
      padding: 4px 6px 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .card-name {
      font-weight: bold;
      font-size: 12px;
    }
    .card-meta {
      font-size: 11px;
      color: #666;
    }
    .card-status {
      font-size: 11px;
      margin-top: 2px;
    }
    .card-status span {
      padding: 1px 4px;
      border-radius: 999px;
      font-size: 10px;
      background: #eee;
    }
    .card-status span.obtained {
      background: #4caf50;
      color: #fff;
    }
    .badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(76, 175, 80, 0.9);
      color: #fff;
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 999px;
    }
    .hint {
      font-size: 11px;
      color: #999;
    }
    .legend {
      font-size: 11px;
      margin-top: 6px;
      color: #555;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      margin-right: 10px;
      gap: 3px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .legend-dot.obtained {
      background: #4caf50;
    }
    .legend-dot.not {
      background: #ccc;
    }
    .match-log {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
      max-height: 100px;
      overflow-y: auto;
      border-top: 1px dashed #eee;
      padding-top: 4px;
    }
    .match-log div {
      margin-bottom: 2px;
    }
  </style>
</head>
<body>
<header>
  <h1>アイマスツアーズ カード取得管理</h1>
  <small>OpenCV.js ORB特徴量マッチング ＋ カメラ認識対応</small>
</header>

<main>
  <!-- カメラ＆認識パネル -->
  <section id="camera-panel" class="panel">
    <h2>カメラ認識 / 参照カード登録</h2>

    <video id="video" autoplay playsinline></video>
    <canvas id="captureCanvas" style="display:none;"></canvas>

    <div class="controls">
      <button id="startCameraBtn" class="secondary">カメラ開始</button>
      <button id="stopCameraBtn" class="secondary" disabled>停止</button>
      <button id="captureBtn" class="primary" disabled>このフレームでカード判定</button>
    </div>

    <div class="status" id="cameraStatus">OpenCV.js 読み込み中…</div>

<!-- ▼ ここから追加：カード名自動生成UI ▼ -->

<div class="field">
  <label>弾数</label>
  <select id="seriesSelect"></select>
</div>

<div class="field">
  <label>カードNo</label>
  <select id="cardNoSelect"></select>
</div>

<div class="field">
  <label>レアリティ</label>
  <select id="raritySelect">
    <option value="N">N</option>
    <option value="R">R</option>
    <option value="SR">SR</option>
    <option value="SSR">SSR</option>
    <option value="CO">CO</option>
    <option value="TR">TR</option>
    <option value="CP">CP</option>
    <option value="P">P</option>
  </select>
</div>

<div class="field">
  <label>カード名（キャラ名）</label>
  <select id="characterSelect"></select>
  <button id="addCharacterBtn" class="secondary">追加</button>
  <button id="removeCharacterBtn" class="secondary">削除</button>
</div>

<div class="field">
  <label>生成されたカード名</label>
  <input id="generatedName" type="text" readonly />
</div>

<!-- ▲ ここまで追加：カード名自動生成UI ▲ -->

<div class="field">
  <label>並び替え</label>
  <select id="sortSelect">
    <option value="default">登録順</option>
    <option value="series">弾数順</option>
    <option value="cardNo">カードNo順</option>
    <option value="rarity">レアリティ順</option>
    <option value="name">キャラ名順</option>
    <option value="obtained">取得状況順（取得済→未取得）</option>
  </select>
</div>


    <div class="field">
      <label for="cardNameInput">新しいカードを追加（参照画像登録）</label>
      <input id="cardNameInput" type="text" placeholder="カード名（例: 天海春香 SR）」 />
    </div>
    <div class="field">
      <label>参照画像の選択（ファイル or 現在のカメラフレーム）</label>
      <input id="refFileInput" type="file" accept="image/*">
      <button id="useCurrentFrameBtn" class="secondary" disabled>カメラフレームを参照画像として登録</button>
      <div class="hint">カード一覧に使う画像です。カード正面ができるだけ大きく写るようにしてください。</div>
    </div>
    <div class="controls">
      <button id="addCardBtn" class="primary" disabled>カード一覧に追加</button>
    </div>

    <div class="legend">
      <span><span class="legend-dot obtained"></span>取得済</span>
      <span><span class="legend-dot not"></span>未取得</span>
    </div>

    <div class="match-log" id="matchLog"></div>
<button id="exportCsvBtn" class="secondary">CSV 出力</button>
<input type="file" id="importCsvInput" accept=".csv" style="display:none;">
<button id="importCsvBtn" class="secondary">CSV 読み込み</button>
<div id="csvVersionDisplay" class="hint">CSV ver: 0</div>
<button id="toggleSimpleViewBtn" class="secondary">簡易表示モード</button>
<div id="seriesProgressDisplay" class="hint"></div>
  </section>

  <!-- カード一覧 & 取得率パネル -->
  <section id="list-panel" class="panel">
    <div class="cards-header">
      <h2>カード一覧</h2>
      <div style="flex:1; display:flex; align-items:center; gap:6px;">
        <div class="progress-bar-wrap">
          <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="progress-text">0 / 0 (0%)</div>
      </div>
    </div>
    <div class="hint">カードを認識すると自動的に「取得済」になります。</div>
    <div class="card-list" id="cardList"></div>
  </section>
</main>

<!-- OpenCV.js（公式CDNの一例。環境によって変更可） -->
<script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>


<script>

let simpleView = false;
let db;

function openImageDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("CardImageDB", 1);

    request.onupgradeneeded = (e) => {
      db = e.target.result;

      // images というストア（テーブル）が無ければ作成
      if (!db.objectStoreNames.contains("images")) {
        db.createObjectStore("images", { keyPath: "id" });
      }
    };

    request.onsuccess = (e) => {
      db = e.target.result;
      console.log("IndexedDB: CardImageDB を開きました");
      resolve();
    };

    request.onerror = (e) => {
      console.error("IndexedDB エラー:", e);
      reject(e);
    };
  });
}


function updateSeriesProgress() {
  const seriesStats = {
    "01": { total: 0, obtained: 0 },
    "02": { total: 0, obtained: 0 },
    "03": { total: 0, obtained: 0 },
    "CP":  { total: 0, obtained: 0 }   // ★ 追加

  };

  for (const card of cards) {
    const series = card.name.substring(0, 2); // 先頭2桁が弾数

    if (seriesStats[series]) {
      seriesStats[series].total++;
      if (card.obtained) {
        seriesStats[series].obtained++;
      }
    }
  }

  // HTML に表示
  const el = document.getElementById("seriesProgressDisplay");
  el.innerHTML = `
    第1弾: ${seriesStats["01"].obtained} / ${seriesStats["01"].total}  
    （${seriesStats["01"].total ? Math.round(seriesStats["01"].obtained / seriesStats["01"].total * 100) : 0}%）<br>
    第2弾: ${seriesStats["02"].obtained} / ${seriesStats["02"].total}  
    （${seriesStats["02"].total ? Math.round(seriesStats["02"].obtained / seriesStats["02"].total * 100) : 0}%）<br>
    第3弾: ${seriesStats["03"].obtained} / ${seriesStats["03"].total}  
    （${seriesStats["03"].total ? Math.round(seriesStats["03"].obtained / seriesStats["03"].total * 100) : 0}%）<br>
  CP(キャンペーンカード): ${seriesStats["CP"].obtained} / ${seriesStats["CP"].total}
    （${seriesStats["CP"].total ? Math.round(seriesStats["CP"].obtained / seriesStats["CP"].total * 100) : 0}%）
  `;
}


  // -----------------------------
  // データ構造 & ストレージ
  // -----------------------------

  const STORAGE_KEY = 'imas_tours_cards_v1';
const CSV_VERSION_KEY = "imas_tours_csv_version";

  /**
   * card = {
   *   id: string,
   *   name: string,
   *   imageDataUrl: string,
   *   obtained: boolean
   * }
   */
  let cards = [];

  function loadCards() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        cards = JSON.parse(raw);
      } else {
        cards = [];
      }
    } catch (e) {
      console.error(e);
      cards = [];
    }
    renderCardList();

  }

// ★ 既存 localStorage の画像 → IndexedDB へ移行
async function migrateLocalStorageImages() {
  console.log("=== 画像移行チェック開始 ===");

  for (const card of cards) {
    // すでに移行済みならスキップ
    if (card.imageKey && card.imageDataUrl === "") continue;

    // localStorage に画像が残っていない場合もスキップ
    if (!card.imageDataUrl) continue;

    console.log(`移行対象: ${card.id} / ${card.name}`);

    // IndexedDB に保存
    await saveImageToDB(card.id, card.imageDataUrl);

    // カード情報を更新
    card.imageKey = card.id;
    card.imageDataUrl = ""; // localStorage から削除
  }

  saveCards();
  console.log("=== 画像移行完了 ===");
}

function getCsvVersion() {
  return Number(localStorage.getItem(CSV_VERSION_KEY) || "0");
}

function incrementCsvVersion() {
  const v = getCsvVersion() + 1;
  localStorage.setItem(CSV_VERSION_KEY, String(v));
  return v;
}


document.getElementById("toggleSimpleViewBtn").addEventListener("click", () => {
  simpleView = !simpleView;
  renderCardList();
});

  function saveCards() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
  }

  // -----------------------------
  // DOM 取得
  // -----------------------------

  const video = document.getElementById('video');
  const captureCanvas = document.getElementById('captureCanvas');
  const startCameraBtn = document.getElementById('startCameraBtn');
  const stopCameraBtn = document.getElementById('stopCameraBtn');
  const captureBtn = document.getElementById('captureBtn');
  const useCurrentFrameBtn = document.getElementById('useCurrentFrameBtn');
  const cameraStatus = document.getElementById('cameraStatus');
  const cardNameInput = document.getElementById('cardNameInput');
  const refFileInput = document.getElementById('refFileInput');
  const addCardBtn = document.getElementById('addCardBtn');
  const cardListEl = document.getElementById('cardList');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const matchLog = document.getElementById('matchLog');

  let stream = null;
  let opencvReady = false;

  // 参照画像として保持する一時的なDataURL
  let pendingRefImageDataUrl = null;

  // -----------------------------
  // OpenCV.js 読み込み待ち
  // -----------------------------
  function onOpenCvReady() {
    opencvReady = true;
    cameraStatus.textContent = 'OpenCV.js 準備完了。カメラを開始できます。';
    captureBtn.disabled = !stream;
    useCurrentFrameBtn.disabled = !stream;
  }

  // opencv.js が読み込まれると Module.onRuntimeInitialized が呼ばれる
  window.Module = {
    onRuntimeInitialized() {
      onOpenCvReady();
    }
  };

  // -----------------------------
  // カメラ制御
  // -----------------------------

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' },
        audio: false
      });
      video.srcObject = stream;
      cameraStatus.textContent = 'カメラ動作中。カードを写して「カード判定」を押してください。';
      startCameraBtn.disabled = true;
      stopCameraBtn.disabled = false;
      captureBtn.disabled = !opencvReady;
      useCurrentFrameBtn.disabled = !opencvReady;
    } catch (e) {
      console.error(e);
      cameraStatus.textContent = 'カメラの起動に失敗しました。ブラウザの権限設定を確認してください。';
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    startCameraBtn.disabled = false;
    stopCameraBtn.disabled = true;
    captureBtn.disabled = true;
    useCurrentFrameBtn.disabled = true;
    cameraStatus.textContent = 'カメラ停止中。';
  }

  startCameraBtn.addEventListener('click', startCamera);
  stopCameraBtn.addEventListener('click', stopCamera);

  // -----------------------------
  // カメラフレームをCanvasに取得
  // -----------------------------

  function grabFrameToCanvas() {
    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) return null;
    captureCanvas.width = w;
    captureCanvas.height = h;
    const ctx = captureCanvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    return captureCanvas;
  }

  // -----------------------------
  // DataURL への変換
  // -----------------------------

  function canvasToDataUrl(canvas, mimeType = 'image/jpeg', quality = 0.9) {
    return canvas.toDataURL(mimeType, quality);
  }

  function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  // -----------------------------
  // 参照画像登録フロー
  // -----------------------------

  // ファイル選択 → DataURL を pendingRefImageDataUrl に保持
  refFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const dataUrl = await fileToDataUrl(file);
      pendingRefImageDataUrl = dataUrl;
      cameraStatus.textContent = '参照画像を読み込みました。「カード一覧に追加」で登録できます。';
      updateAddButtonState();
    } catch (err) {
      console.error(err);
      cameraStatus.textContent = '参照画像の読み込みに失敗しました。';
    }
  });

  // カメラからフレームを取得して参照画像に使う
  useCurrentFrameBtn.addEventListener('click', () => {
    const canvas = grabFrameToCanvas();
    if (!canvas) {
      cameraStatus.textContent = 'カメラフレームを取得できませんでした。';
      return;
    }
    pendingRefImageDataUrl = canvasToDataUrl(canvas);
    cameraStatus.textContent = '現在のカメラフレームを参照画像としてセットしました。';
    updateAddButtonState();
  });

  function updateAddButtonState() {
    const nameFilled = cardNameInput.value.trim().length > 0;
    addCardBtn.disabled = !(nameFilled && pendingRefImageDataUrl);
  }

  cardNameInput.addEventListener('input', updateAddButtonState);

  // カード追加
addCardBtn.addEventListener('click', async () => {
  const name = cardNameInput.value.trim();
  if (!name || !pendingRefImageDataUrl) return;

  // ★ 正しいID生成
  const id = 'card_' + Date.now();

  // ★ 画像を IndexedDB に保存
  await saveImageToDB(id, pendingRefImageDataUrl);

  // ★ localStorage には画像を保存しない
  const card = {
    id,
    name,
    imageKey: id,     // 画像のキー
    imageDataUrl: "", // localStorage には保存しない
    obtained: false,
    csvImported: false
  };

  cards.push(card);
  saveCards();
  renderCardList();

  cardNameInput.value = '';
  refFileInput.value = '';
  pendingRefImageDataUrl = null;
  addCardBtn.disabled = true;
  cameraStatus.textContent = `「${card.name}」をカード一覧に追加しました。`;
});


function playBeep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "sine";      // 音の種類（sine = ピー）
  osc.frequency.value = 880; // 周波数（高めの音）
  osc.frequency.value = 880; // 周波数（高めの音）

  gain.gain.setValueAtTime(0.6, ctx.currentTime); // 音量
  gain.gain.exponentialRampToValueAtTime(0.002, ctx.currentTime + 0.15);

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start();
  osc.stop(ctx.currentTime + 50000); // 0.15秒で終了
}

function sortCards() {
  const mode = document.getElementById("sortSelect").value;

  if (mode === "default") {
    // 何もしない（登録順）
    return;
  }

  cards.sort((a, b) => {
    const [seriesA, noA, rarityA, nameA] = a.name.split(/[- ]+/);
    const [seriesB, noB, rarityB, nameB] = b.name.split(/[- ]+/);

    switch (mode) {
      case "series":
        return seriesA.localeCompare(seriesB);
      case "cardNo":
        return noA.localeCompare(noB);
      case "rarity":
        return rarityA.localeCompare(rarityB);
      case "name":
        return nameA.localeCompare(nameB);
      case "obtained":
        return (b.obtained ? 1 : 0) - (a.obtained ? 1 : 0);
    }
  });
}


  // -----------------------------
  // カード一覧の描画 & 取得率
  // -----------------------------


document.getElementById("sortSelect").addEventListener("change", renderCardList);


  function renderCardList() {


if (simpleView) {
  // ★ 簡易表示モード（画像なし）
  cardListEl.innerHTML = '';
  cards.forEach(card => {
    const item = document.createElement('div');
    item.className = 'card-item';
    item.style.padding = '8px';
    item.style.background = card.obtained
      ? (card.csvImported ? 'orange' : 'lightgreen')
      : '#ccc';

    item.textContent = `${card.name}  /  ${card.obtained ? '取得済' : '未取得'}`;



    cardListEl.appendChild(item);
  });









  updateProgress();
updateSeriesProgress();
  return; // ★ 通常表示をスキップ
}




sortCards();
//document.getElementById("sortSelect").addEventListener("change", renderCardList);
    cardListEl.innerHTML = '';
    cards.forEach(card => {
      const item = document.createElement('div');
      item.className = 'card-item' + (card.obtained ? ' obtained' : '');

let color = "#ccc"; // 未取得（グレー）

if (card.obtained && card.csvImported) {
  color = "orange"; // CSV取得（未スキャン）
} else if (card.obtained) {
  color = "lightgreen"; // カメラ取得済
}

item.style.backgroundColor = color;

      const thumbWrap = document.createElement('div');
      thumbWrap.className = 'card-thumb-wrap';
      const img = document.createElement('img');
      // ★ IndexedDB から画像を読み込む
loadImageFromDB(card.imageKey).then(dataUrl => {
  img.src = dataUrl || "";
});

      thumbWrap.appendChild(img);

      const body = document.createElement('div');
      body.className = 'card-body';

      const nameEl = document.createElement('div');
      nameEl.className = 'card-name';
      nameEl.textContent = card.name;

      const metaEl = document.createElement('div');
      metaEl.className = 'card-meta';
      metaEl.textContent = `ID: ${card.id}`;

      const statusEl = document.createElement('div');
      statusEl.className = 'card-status';
      const span = document.createElement('span');
      span.textContent = card.obtained ? '取得済' : '未取得';
      span.className = card.obtained ? 'obtained' : '';

      statusEl.appendChild(span);

      body.appendChild(nameEl);
      body.appendChild(metaEl);
      body.appendChild(statusEl);

// ★ ボタン表示ロジック

// 1. CLEAR ボタン（取得済みなら表示）
if (card.obtained) {
  const clearBtn = document.createElement('button');
  clearBtn.textContent = 'CLEAR';
  clearBtn.style.marginTop = '4px';
  clearBtn.style.fontSize = '10px';
  clearBtn.style.padding = '2px 6px';
  clearBtn.style.background = '#eee';
  clearBtn.style.borderRadius = '4px';

  clearBtn.onclick = () => {
    card.obtained = false;
    card.csvImported = false;
    saveCards();
    renderCardList();
  };

  body.appendChild(clearBtn);
}

// 2. 手動取得（CSV扱い）ボタン
//    → 未取得（グレー）または CSV取得（オレンジ）のときだけ表示
if (!card.obtained || card.csvImported) {
  const manualBtn = document.createElement('button');
  manualBtn.textContent = '手動取得（CSV扱い）';
  manualBtn.style.marginTop = '4px';
  manualBtn.style.fontSize = '10px';
  manualBtn.style.padding = '2px 6px';
  manualBtn.style.background = '#ffe0b2';
  manualBtn.style.borderRadius = '4px';

  manualBtn.onclick = () => {
    card.obtained = true;
    card.csvImported = true; // ← オレンジ扱い
    saveCards();
    renderCardList();
  };

  body.appendChild(manualBtn);
}
    



      item.appendChild(thumbWrap);
      item.appendChild(body);

      if (card.obtained) {
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = 'GET!';
        item.appendChild(badge);
      }

      cardListEl.appendChild(item);
    });

    updateProgress();
updateSeriesProgress();

  }

  function updateProgress() {
    const total = cards.length;
    const obtained = cards.filter(c => c.obtained).length;
    const pct = total > 0 ? Math.round((obtained / total) * 100) : 0;
    progressBar.style.width = pct + '%';
    progressText.textContent = `${obtained} / ${total} (${pct}%)`;
  }

  // -----------------------------
  // OpenCV.js で特徴量マッチング
  //   - ORB + BFMatcher(Hamming)
  // -----------------------------
  // 参考: ORB特徴点を用いた画像認識のPoC

  function logMatch(text) {
    const div = document.createElement('div');
    div.textContent = text;
    matchLog.prepend(div);
  }

  function dataUrlToMat(dataUrl) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        try {
          const mat = cv.imread(img);
          resolve(mat);
        } catch (e) {
          reject(e);
        }
      };
      img.onerror = err => reject(err);
      img.src = dataUrl;
    });
  }



document.getElementById("importCsvBtn").addEventListener("click", () => {
  document.getElementById("importCsvInput").click();
});

document.getElementById("importCsvInput").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) importCsv(file);
});


  function canvasToMat(canvas) {
    const mat = cv.imread(canvas);
    return mat;
  }

  async function computeOrbDescriptorsFromDataUrl(dataUrl) {
    const src = await dataUrlToMat(dataUrl);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    const orb = new cv.ORB();
    const keypoints = new cv.KeyPointVector();
    const descriptors = new cv.Mat();
    orb.detectAndCompute(gray, new cv.Mat(), keypoints, descriptors);

    src.delete();
    gray.delete();
    orb.delete();
    keypoints.delete();

    return descriptors;
  }

function loadImageFromDB(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("images", "readonly");
    const store = tx.objectStore("images");
    const req = store.get(id);

    req.onsuccess = () => {
      if (req.result) {
        resolve(req.result.dataUrl);  // Base64 を返す
      } else {
        resolve(""); // 見つからない場合は空
      }
    };

    req.onerror = (e) => {
      console.error("IndexedDB: 画像読み込みエラー", e);
      reject(e);
    };
  });
}

function saveImageToDB(id, dataUrl) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("images", "readwrite");
    const store = tx.objectStore("images");
    const req = store.put({ id, dataUrl });

    req.onsuccess = () => resolve();
    req.onerror = (e) => {
      console.error("IndexedDB: 画像保存エラー", e);
      reject(e);
    };
  });
}

  function computeOrbDescriptorsFromCanvas(canvas) {
    const src = canvasToMat(canvas);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    const orb = new cv.ORB();
    const keypoints = new cv.KeyPointVector();
    const descriptors = new cv.Mat();
    orb.detectAndCompute(gray, new cv.Mat(), keypoints, descriptors);

    src.delete();
    gray.delete();
    orb.delete();
    keypoints.delete();

    return descriptors;
  }

  async function recognizeCardFromCurrentFrame() {
    if (!opencvReady) {
      cameraStatus.textContent = 'OpenCV.js がまだ準備できていません。少し待ってください。';
      return;
    }
    if (!cards.length) {
      cameraStatus.textContent = 'カード一覧が空です。先に参照カードを追加してください。';
      return;
    }

    const canvas = grabFrameToCanvas();
    if (!canvas) {
      cameraStatus.textContent = 'カメラフレームを取得できませんでした。';
      return;
    }

    cameraStatus.textContent = '特徴量抽出とマッチングを実行中…';
    logMatch('---- 新しい判定 ----');

    let frameDesc = null;
    try {
      frameDesc = computeOrbDescriptorsFromCanvas(canvas);
    } catch (e) {
      console.error(e);
      cameraStatus.textContent = 'フレームから特徴量を抽出できませんでした。';
      return;
    }

    if (frameDesc.empty()) {
      frameDesc.delete();
      cameraStatus.textContent = 'フレームから有効な特徴量を取得できませんでした。撮影条件を変えてみてください。';
      return;
    }

    const bf = new cv.BFMatcher(cv.NORM_HAMMING, true);
    let bestCard = null;
    let bestMatchCount = 0;

 for (let card of cards) {
  let cardDesc = null;

  try {
    // ★ IndexedDB から画像をロード
    const dataUrl = await loadImageFromDB(card.imageKey);

    if (!dataUrl) {
      logMatch(`カード「${card.name}」の画像が IndexedDB にありません`);
      continue;
    }

    // ★ ORB 特徴量を抽出
    cardDesc = await computeOrbDescriptorsFromDataUrl(dataUrl);

  } catch (e) {
    console.error(e);
    logMatch(`カード「${card.name}」の特徴量抽出に失敗`);
    continue;
  }

      if (cardDesc.empty()) {
        cardDesc.delete();
        logMatch(`カード「${card.name}」の特徴量が空です`);
        continue;
      }

      const matches = new cv.DMatchVector();
      bf.match(cardDesc, frameDesc, matches);

      const count = matches.size();
      logMatch(`「${card.name}」: マッチ数 ${count}`);

      if (count > bestMatchCount) {
        bestMatchCount = count;
        bestCard = card;
      }

      matches.delete();
      cardDesc.delete();
    }

    frameDesc.delete();
    bf.delete();

    // マッチ数の閾値（経験的に調整が必要）
    const MATCH_THRESHOLD = 179;

    if (bestCard && bestMatchCount >= MATCH_THRESHOLD) {
      cameraStatus.textContent = `カード認識成功: 「${bestCard.name}」（マッチ数 ${bestMatchCount}）`;
      logMatch(`==> 認識: 「${bestCard.name}」 / マッチ数 ${bestMatchCount}`);

// ★ ファイル不要のビープ音を鳴らす
  playBeep();


      if (!bestCard.obtained || bestCard.csvImported) {
        bestCard.obtained = true;

    if(bestCard.csvImported){
 bestCard.obtained = true;
bestCard.csvImported = false;   // ← カメラで取得したので CSV扱いを解除

}

        saveCards();
        renderCardList();
      }
    } else {
      cameraStatus.textContent = `カード認識に失敗しました（最良マッチ数: ${bestMatchCount}）。カードを正面に大きく写して再試行してください。`;
      logMatch('==> 認識失敗');
    }
  }

  captureBtn.addEventListener('click', recognizeCardFromCurrentFrame);


// -----------------------------
// 100フレームごと自動判定
// -----------------------------
let autoDetectEnabled = true;   // 自動判定ON/OFF（必要ならUIで切り替え可能）
let frameCounter = 0;

function autoDetectLoop() {
  if (stream && autoDetectEnabled && opencvReady) {
    frameCounter++;

    // 100フレームに1回だけ判定
    if (frameCounter % 100 === 0) {
      recognizeCardFromCurrentFrame();
    }
  }

  requestAnimationFrame(autoDetectLoop);
}

// 自動ループ開始
requestAnimationFrame(autoDetectLoop);


// CSV 出力（IndexedDB 対応）
exportCsvBtn.addEventListener("click", () => {

  // ★ バージョンを +1
  const version = incrementCsvVersion();


  const header = [
    "version",
    "id",
    "name",
    "imageKey",
    "obtained",
    "csvImported"
  ];

  const rows = cards.map(card => [
    version,
    card.id,
    card.name,
    card.imageKey || "",
    card.obtained ? "true" : "false",
    card.csvImported ? "true" : "false"
  ]);

  const csv = [header.join(","), ...rows.map(r => r.join(","))].join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `cards_export_v${version}.csv`; // ★ ファイル名にも反映
  a.click();

  URL.revokeObjectURL(url);
updateCsvVersionDisplay();
});


// CSV 読み込み（IndexedDB 対応）
function importCsv(file) {
  const reader = new FileReader();

if (header[0] === "version") {
  lines.shift(); // version 行を削除
}

  reader.onload = async () => {
    const text = reader.result;
    const lines = text.trim().split("\n");

    const header = lines[0].split(",");
    const idx = {
      version: header.indexOf("version"), // ← 追加
      id: header.indexOf("id"),
      name: header.indexOf("name"),
      imageKey: header.indexOf("imageKey"),
      obtained: header.indexOf("obtained"),
      csvImported: header.indexOf("csvImported")
    };

    const newCards = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");

      const card = {
        id: cols[idx.id],
        name: cols[idx.name],
        imageKey: cols[idx.imageKey],
        imageDataUrl: "", // localStorage には保存しない
        obtained: cols[idx.obtained] === "true",
        csvImported: cols[idx.csvImported] === "true"
      };

      newCards.push(card);
    }

    cards = newCards;
    saveCards();
    renderCardList();
    updateProgress();

    alert("CSV を読み込みました（画像は IndexedDB から読み込みます）");
  };

  reader.readAsText(file);
}

function updateCsvVersionDisplay() {
  const v = getCsvVersion();
  document.getElementById("csvVersionDisplay").textContent = `CSV ver: ${v}`;
}


  // -----------------------------
  // 初期化
  // -----------------------------

  loadCards();
updateCsvVersionDisplay();
updateSeriesProgress();



openImageDB().then(() => {
  migrateLocalStorageImages().then(() => {
    renderCardList(); // ← 移行後に描画し直す
  });
});



// ▼ カード名自動生成UIの初期化 ▼

let characters = JSON.parse(localStorage.getItem("characters") || "[]");

function initDropdowns() {
  const seriesSelect = document.getElementById("seriesSelect");
  for (let i = 1; i <= 11; i++) {
    const v = String(i).padStart(2, "0");
    seriesSelect.innerHTML += `<option value="${v}">${v}</option>`;
  }


// ★ P弾を追加
  const optP = document.createElement("option");
  optP.value = "CP";
  optP.textContent = "CP（キャンペーン）";
  seriesSelect.appendChild(optP);


  const cardNoSelect = document.getElementById("cardNoSelect");
  for (let i = 1; i <= 101; i++) {
    const v = String(i).padStart(3, "0");
    cardNoSelect.innerHTML += `<option value="${v}">${v}</option>`;
  }

  refreshCharacterList();
}

function refreshCharacterList() {
  const select = document.getElementById("characterSelect");
  select.innerHTML = "";
  characters.forEach(name => {
    select.innerHTML += `<option value="${name}">${name}</option>`;
  });
}

function updateGeneratedName() {
  const series = document.getElementById("seriesSelect").value;
  const cardNo = document.getElementById("cardNoSelect").value;
  const rarity = document.getElementById("raritySelect").value;
  const character = document.getElementById("characterSelect").value;

  const name = `${series}-${cardNo} ${rarity} ${character}`;
  document.getElementById("generatedName").value = name;

  // 既存の cardNameInput に反映
  document.getElementById("cardNameInput").value = name;
  updateAddButtonState();
}

["seriesSelect", "cardNoSelect", "raritySelect", "characterSelect"].forEach(id => {
  document.getElementById(id).addEventListener("change", updateGeneratedName);
});

document.getElementById("addCharacterBtn").addEventListener("click", () => {
  const name = prompt("追加するキャラ名を入力してください");
  if (name) {
    characters.push(name);
    localStorage.setItem("characters", JSON.stringify(characters));
    refreshCharacterList();
    updateGeneratedName();
  }
});

document.getElementById("removeCharacterBtn").addEventListener("click", () => {
  const select = document.getElementById("characterSelect");
  const name = select.value;
  if (!name) return;

  if (confirm(`${name} を削除しますか？`)) {
    characters = characters.filter(c => c !== name);
    localStorage.setItem("characters", JSON.stringify(characters));
    refreshCharacterList();
    updateGeneratedName();
  }
});

// 初期化
initDropdowns();
updateGeneratedName();
openImageDB(); // ← これを追加


// ▲ カード名自動生成UIの初期化 ▲
  cameraStatus.textContent = 'OpenCV.js の読み込みを待機中…（数秒かかる場合があります）';

// ▼ CSV 出力用：リビジョン管理（ローカル保存）
let exportRevision = Number(localStorage.getItem("exportRevision") || 1);

// CSV 出力メイン処理（画像列つき）
function exportCsv() {
  const now = new Date().toISOString();
  const rev = exportRevision++;

  // リビジョン保存
  localStorage.setItem("exportRevision", exportRevision);

  // CSV ヘッダ
  let csv = "revision,exported_at,id,name,series,cardNo,rarity,character,obtained,csvImported,image\n";

  cards.forEach(card => {
    // name を分解（例：03-012 SR 天海春香）
    const match = card.name.match(/^(\d+)-(\d+)\s+(\S+)\s+(.+)$/);
    let series = "", cardNo = "", rarity = "", character = "";

    if (match) {
      series = match[1];
      cardNo = match[2];
      rarity = match[3];
      character = match[4];
    }

    // 画像（Base64）を CSV 用にダブルクォートで囲む
    const image = card.imageDataUrl ? `"${card.imageDataUrl}"` : "";

    csv += [
      rev,
      now,
      card.id,
      `"${card.name}"`,
      series,
      cardNo,
      rarity,
      `"${character}"`,
      card.obtained,
	card.csvImported ? "true" : "false",  // ← ここが追加！
      image
    ].join(",") + "\n";
  });

  // ダウンロード処理
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `cards_export_rev${rev}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}



// ボタンにイベント登録
document.getElementById("exportCsvBtn").addEventListener("click", exportCsv);
updateCsvVersionDisplay();


// ▼ ここに入れる：CSV パーサー（2番）
function parseCsv(text) {
  const lines = text.split("\n").filter(l => l.trim() !== "");
  const header = lines[0].split(",");
  const rows = lines.slice(1);

  return rows.map(line => {
    const cols = [];
    let current = "";
    let insideQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const c = line[i];

      if (c === '"' && line[i + 1] === '"') {
        current += '"';
        i++;
      } else if (c === '"') {
        insideQuotes = !insideQuotes;
      } else if (c === "," && !insideQuotes) {
        cols.push(current);
        current = "";
      } else {
        current += c;
      }
    }
    cols.push(current);

    const obj = {};
    header.forEach((h, i) => {
      obj[h] = cols[i];
    });
    return obj;
  });
}
// ▲ ここまでが 2番（CSV パーサー）


// ▼ CSV 読み込み機能 ▼

// CSV をパースする簡易関数
function parseCsv(text) {
  const lines = text.split("\n").filter(l => l.trim() !== "");
  const header = lines[0].split(",");
  const rows = lines.slice(1);

  return rows.map(line => {
    // カンマ区切り + ダブルクォート対応
    const cols = [];
    let current = "";
    let insideQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const c = line[i];

      if (c === '"' && line[i + 1] === '"') {
        current += '"';
        i++;
      } else if (c === '"') {
        insideQuotes = !insideQuotes;
      } else if (c === "," && !insideQuotes) {
        cols.push(current);
        current = "";
      } else {
        current += c;
      }
    }
    cols.push(current);

    const obj = {};
    header.forEach((h, i) => {
      obj[h] = cols[i];
    });
    return obj;
  });
}

// ▼ CSV 修復ツール：image 列の破損を検出して修復する
function fixCsvRows(rows) {
  return rows.map((r, index) => {
    let fixed = { ...r };

    // --- 1. image 列が存在しない場合 ---
    if (!("image" in r)) {
      console.warn(`Row ${index}: image 列が存在しません`);
      fixed.image = "";
      return fixed;
    }

    let img = r.image;

    // --- 2. ダブルクォート除去（正常系） ---
    img = img.replace(/^"|"$/g, "");

    // --- 3. Base64 の先頭が正しいかチェック ---
    if (!img.startsWith("data:image")) {
      console.warn(`Row ${index}: Base64 の先頭が不正 → 修復を試みます`);

      // もし途中で切れている場合、前後の列を結合して修復
      const possible = Object.values(r).join("");
      const match = possible.match(/data:image\/[a-zA-Z]+;base64,[A-Za-z0-9+/=]+/);

      if (match) {
        console.log(`Row ${index}: Base64 を自動修復しました`);
        img = match[0];
      } else {
        console.error(`Row ${index}: Base64 を修復できませんでした`);
        img = "";
      }
    }

    // --- 4. ダブルクォートを戻す（CSV 形式に合わせる） ---
    fixed.image = `"${img}"`;

    return fixed;
  });
}

function saveImageToDB(id, dataUrl) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("images", "readwrite");
    const store = tx.objectStore("images");

    // 保存するデータの形
    const record = {
      id: id,          // カードID（キー）
      dataUrl: dataUrl // Base64画像
    };

    const request = store.put(record);

    request.onsuccess = () => {
      console.log("IndexedDB: 画像を保存しました →", id);
      resolve();
    };

    request.onerror = (e) => {
      console.error("IndexedDB: 画像保存エラー", e);
      reject(e);
    };
  });
}

// CSV 読み込みメイン処理
//function importCsv(file) {
//  const reader = new FileReader();
//
//  reader.onload = () => {
//    const text = reader.result;
//    const rows = parseCsv(text);
//
//    cards = rows.map(r => ({
//      id: r.id,
//      name: r.name.replace(/^"|"$/g, ""),
//      imageDataUrl: r.image ? r.image.replace(/^"|"$/g, "") : "",
//      obtained: r.obtained === "true",
//      csvImported: r.csvImported === "true"   // ← CSVで取得扱いなら true
//    }));
//
//    saveCards();
//    renderCardList();
//    updateProgress();
//
//    alert("CSV からカードデータを復元しました！");
//  };
//
//  reader.readAsText(file);
//}

// CSV 読み込み（IndexedDB 対応）
function importCsv(file) {
  const reader = new FileReader();

  reader.onload = async () => {
    const text = reader.result;
    const lines = text.trim().split("\n");

    const header = lines[0].split(",");
    const idx = {
      id: header.indexOf("id"),
      name: header.indexOf("name"),
      imageKey: header.indexOf("imageKey"),
      obtained: header.indexOf("obtained"),
      csvImported: header.indexOf("csvImported")
    };

    const newCards = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");

      const card = {
        id: cols[idx.id],
        name: cols[idx.name],
        imageKey: cols[idx.imageKey],
        imageDataUrl: "", // localStorage には保存しない
        obtained: cols[idx.obtained] === "true",
        csvImported: cols[idx.csvImported] === "true"
      };

      newCards.push(card);
    }

    cards = newCards;
    saveCards();
    renderCardList();
    updateProgress();

    alert("CSV を読み込みました（画像は IndexedDB から読み込みます）");
  };

  reader.readAsText(file);
}
</script>
</body>
</html>